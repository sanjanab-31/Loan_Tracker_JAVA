<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Loan EMI Payment Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        canvas { height: 300px !important; }
        h2, h4, h5 { font-family: 'Segoe UI', sans-serif; }
    </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" th:href="@{/}">LoanTracker</a>
    </div>
</nav>
<div class="container app-container mt-4">
    <h2 class="text-center mb-4">Loan EMI Payment Details</h2>
    <div class="card p-3 mb-4 shadow-sm">
        <h5>Loan Summary</h5>
        <table class="table table-bordered text-center">
            <tr class="table-primary">
                <th>Total EMIs</th>
                <th>Paid EMIs</th>
                <th>Total Paid</th>
                <th>Remaining Balance</th>
                <th>Next Due Date</th>
            </tr>
            <tr>
                <td id="totalEmis" th:text="${summary.totalEmis}">0</td>
                <td id="paidEmis" th:text="${summary.paidEmis}">0</td>
                <td>‚Çπ<span id="totalPaid" th:text="${summary.totalPaid}">0</span></td>
                <td>‚Çπ<span id="remainingBalance" th:text="${summary.remainingBalance}">0</span></td>
                <td id="nextDueDate" th:text="${summary.nextDueDate}">-</td>
            </tr>
        </table>
    </div>
    <div th:if="${success}" class="mt-3">
        <div class="alert alert-success" th:text="${success}"></div>
    </div>
    <div th:if="${error}" class="mt-3">
        <div class="alert alert-danger" th:text="${error}"></div>
    </div>
    <div class="card mb-4">
        <div class="card-header">Record Manual Payment</div>
        <div class="card-body">
            <form th:action="@{/api/emipayments/view/{loanId}/add(loanId=${loan.loanId})}" method="post" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Amount (optional)</label>
                    <input name="amountPaid" type="number" step="0.01" class="form-control" placeholder="Leave blank to use EMI amount">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Payment Date (optional)</label>
                    <input name="paymentDate" type="date" class="form-control">
                </div>
                <div class="col-md-4 align-self-end">
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">EMI Payments</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0 text-center">
                <thead class="table-light">
                <tr>
                    <th>Payment ID</th>
                    <th>Due Date</th>
                    <th>Amount</th>
                    <th>Payment Date</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${payments}">
                    <td th:text="${p.paymentId}"></td>
                    <td th:text="${p.dueDate}"></td>
                    <td>
                        <div th:if="${p.status == 'PAID'}">
                            <span th:text="${p.amountPaid}">0</span>
                        </div>
                        <div th:if="${p.status == 'PARTIAL'}">
                            <div>
                                <strong th:text="${p.amountPaid}">0</strong>
                                <small class="text-muted"> paid</small>
                            </div>
                            <div>
                                <small class="text-danger">Shortfall: ‚Çπ<span th:text="${p.extraDue}">0</span></small>
                            </div>
                        </div>
                        <div th:if="${p.status == null or p.status == 'PENDING'}">
                            <span th:text="${p.extraDue != null ? p.loan.emiAmount + p.extraDue : p.loan.emiAmount}">0</span>
                        </div>
                    </td>
                    <td th:text="${p.paymentDate}"></td>
                    <td>
                <span th:text="${p.status}"
                    th:classappend="${p.status == 'PAID'} ? 'badge bg-success' : 'badge bg-warning text-dark'">
                </span>
                    </td>
                    <td>
            <button th:if="${p.status == 'PENDING'}"
                class="btn btn-sm btn-outline-success pay-btn"
                th:data-id="${p.paymentId}"
                onclick="openPayModal(this)">
                            Pay Now
                        </button>
                        <button th:if="${p.status == 'PAID'}"
                                class="btn btn-sm btn-secondary" disabled>
                            Paid
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="mt-5">
        <h4 class="text-center mb-4">üìä EMI Overview</h4>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white text-center">
                        EMI Status (Paid vs Pending)
                    </div>
                    <div class="card-body">
                        <canvas id="emiPieChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white text-center">
                        Payment History
                    </div>
                    <div class="card-body">
                        <canvas id="emiLineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="msg" class="alert mt-3 text-center d-none"></div>
    <div class="mt-3 text-center">
        <a th:href="@{/}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<div class="modal fade" id="payChoiceModal" tabindex="-1" aria-labelledby="payChoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payChoiceModalLabel">Pay EMI</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="choiceButtons">
                    <p>Do you want to make a full payment or a partial payment?</p>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="chooseFullPayment()">Full Payment</button>
                        <button type="button" class="btn btn-outline-primary" onclick="choosePartialPayment()">Partial Payment</button>
                    </div>
                </div>
                <div id="partialSection" class="d-none mt-3">
                    <label for="partialAmount" class="form-label">Enter amount to pay</label>
                    <input id="partialAmount" type="number" step="0.01" class="form-control" placeholder="Amount">
                </div>
            </div>
            <div class="modal-footer">
                <div id="nextButton" class="d-none">
                    <button type="button" class="btn btn-primary" onclick="partialNext()">Next</button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="partialConfirmModal" tabindex="-1" aria-labelledby="partialConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="partialConfirmModalLabel">Confirm Partial Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Extra tenure will be added to pay the remaining amount.</p>
                <p class="small text-muted">This will append additional tenure to the loan to cover the shortfall.</p>
            </div>
            <div class="modal-footer">
                <button id="confirmPartialBtn" type="button" class="btn btn-primary" onclick="confirmPartialPayment()">Confirm</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    var totalEmis = /*[[${summary != null ? summary.totalEmis : 0}]]*/ 0;
    var paidEmis = /*[[${summary != null ? summary.paidEmis : 0}]]*/ 0;
    var totalPaid = /*[[${summary != null ? summary.totalPaid : 0}]]*/ 0;
    var remainingBalance = /*[[${summary != null ? summary.remainingBalance : 0}]]*/ 0;
    /*]]>*/
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctxPie = document.getElementById('emiPieChart');
        if (ctxPie) {
            new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Paid EMIs', 'Pending EMIs'],
                    datasets: [{
                        data: [paidEmis, totalEmis - paidEmis],
                        backgroundColor: ['#198754', '#dc3545']
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        const ctxLine = document.getElementById('emiLineChart');
        if (ctxLine) {
            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: Array.from({ length: totalEmis }, (_, i) => `EMI ${i + 1}`),
                    datasets: [{
                        label: 'Payment Progress',
                        data: Array.from({ length: totalEmis }, (_, i) => i < paidEmis ? totalPaid / paidEmis : null),
                        borderColor: '#0d6efd',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    });
</script>
<script>
    async function payEmi(paymentId) {
        if (!confirm("Are you sure you want to mark this EMI as paid?")) return;

        try {
            const res = await axios.post(`/api/emipayments/pay/${paymentId}`);
            showMessage(res.data, "success");
            setTimeout(() => window.location.reload(), 1500);
        } catch (err) {
            console.error("Error paying EMI:", err);
            showMessage("Failed to pay EMI. Please try again.", "danger");
        }
    }
    let _currentPaymentId = null;
    let _currentAmount = null;
    function openPayModal(btn) {
        _currentPaymentId = btn.getAttribute('data-id');
        _currentAmount = null;
        const modalEl = document.getElementById('payChoiceModal');
        if (!modalEl) return;
        const modal = new bootstrap.Modal(modalEl);
        // reset form
        modalEl.querySelector('#partialAmount').value = '';
        modalEl.querySelector('#partialSection').classList.add('d-none');
        modalEl.querySelector('#choiceButtons').classList.remove('d-none');
        modalEl.querySelector('#nextButton').classList.add('d-none');
        modal.show();
    }
    function chooseFullPayment() {
        const modalEl = document.getElementById('payChoiceModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();
        payEmi(_currentPaymentId);
    }
    function choosePartialPayment() {
        const modalEl = document.getElementById('payChoiceModal');
        modalEl.querySelector('#partialSection').classList.remove('d-none');
        modalEl.querySelector('#choiceButtons').classList.add('d-none');
        modalEl.querySelector('#nextButton').classList.remove('d-none');
    }
    function partialNext() {
        const modalEl = document.getElementById('payChoiceModal');
        const input = modalEl.querySelector('#partialAmount').value;
        const parsed = Number(input);
        if (!input || isNaN(parsed) || parsed <= 0) { alert('Please enter a valid amount'); return; }
        _currentAmount = parsed;
        const choiceModal = bootstrap.Modal.getInstance(modalEl);
        if (choiceModal) choiceModal.hide();
        const confirmModalEl = document.getElementById('partialConfirmModal');
        const confirmModal = new bootstrap.Modal(confirmModalEl);
        confirmModal.show();
    }
    async function confirmPartialPayment() {
        const confirmBtn = document.getElementById('confirmPartialBtn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            const spinner = document.createElement('span');
            spinner.className = 'spinner-border spinner-border-sm ms-2';
            spinner.setAttribute('role', 'status');
            spinner.setAttribute('aria-hidden', 'true');
            confirmBtn.appendChild(spinner);
        }
        console.log('Confirming partial payment', _currentPaymentId, _currentAmount);
        try {
            const resp = await axios.post(`/api/emipayments/pay/${_currentPaymentId}`, null, { params: { amount: _currentAmount, strategy: 'EXTEND_TENURE' } });
            console.log('Partial payment response', resp.data);
            const confirmModalEl = document.getElementById('partialConfirmModal');
            const cm = bootstrap.Modal.getInstance(confirmModalEl);
            if (cm) cm.hide();
            showMessage('Partial payment recorded. Extra tenure will be added to pay the remaining amount.', 'success');
            setTimeout(() => window.location.reload(), 1200);
        } catch (err) {
            console.error('Error confirming partial payment:', err);
            showMessage('Failed to record partial payment. Please try again. ' + (err?.response?.data || ''), 'danger');
        } finally {
            if (confirmBtn) {
                const sp = confirmBtn.querySelector('.spinner-border');
                if (sp) confirmBtn.removeChild(sp);
                confirmBtn.disabled = false;
            }
        }
    }
    function showMessage(text, type) {
        const msgDiv = document.getElementById("msg");
        msgDiv.textContent = text;
        msgDiv.className = `alert alert-${type} text-center`;
        msgDiv.classList.remove("d-none");
    }
</script>
</body>
</html>
